<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Exam Generator</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>

  <body>
    <div class="container">
      <header>
        <h1><i class="fas fa-graduation-cap"></i> Mock Exam Generator</h1>
        <div class="header-buttons">
          <a href="http://127.0.0.1:8001/" class="evaluate-button">
            <i class="fas fa-clipboard-check"></i> Evaluate Exam
          </a>
          <div id="connection-status" class="status disconnected">
            <span class="status-indicator"></span>
            <span class="status-text">Disconnected</span>
          </div>
        </div>
      </header>

      <main>
        <div class="app-container">
          <div class="chat-container">
            <div id="messages" class="messages-container">
              <div class="welcome-message">
                <h2>Welcome to Mock Exam Generator</h2>
                <p>Chat with the AI to generate customized mock exams. Your generated PDFs will appear in the sidebar.</p>
              </div>
            </div>

            <form id="messageForm" class="message-form">
              <div class="input-container">
                <input 
                  type="text" 
                  id="message" 
                  name="message" 
                  placeholder="Ask the AI to generate a mock exam..." 
                  autocomplete="off"
                />
                <button type="submit" id="sendButton" disabled>
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </form>
          </div>

          <div class="pdf-sidebar">
            <div class="pdf-header">
              <h3><i class="fas fa-file-pdf"></i> Generated Exams</h3>
              <button id="refreshPdfs" class="refresh-button">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <div id="pdfList" class="pdf-list">
              <div class="pdf-loading">
                <p>Loading generated exams...</p>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>
        <p>Powered by Google ADK Streaming</p>
      </footer>
    </div>

    <script>
      // Connect the server with a WebSocket connection
      const sessionId = Math.random().toString().substring(10);
      const ws_url = "ws://" + window.location.host + "/ws/" + sessionId;
      let ws = new WebSocket(ws_url);

      // Get DOM elements
      const messageForm = document.getElementById("messageForm");
      const messageInput = document.getElementById("message");
      const messagesDiv = document.getElementById("messages");
      const connectionStatus = document.getElementById("connection-status");
      const statusText = connectionStatus.querySelector(".status-text");
      const pdfList = document.getElementById("pdfList");
      const refreshPdfsButton = document.getElementById("refreshPdfs");
      let currentMessageId = null;
      let isAgentTyping = false;
      let pdfCheckInterval = null;

      // Function to update connection status
      function updateConnectionStatus(isConnected) {
        if (isConnected) {
          connectionStatus.className = "status connected";
          statusText.textContent = "Connected";
        } else {
          connectionStatus.className = "status disconnected";
          statusText.textContent = "Disconnected";
        }
      }

      // Function to format date
      function formatDate(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString();
      }

      // Function to fetch and display PDF files
      async function fetchPDFs() {
        try {
          const response = await fetch('/list-pdfs');
          const data = await response.json();
          
          if (data.pdfs && data.pdfs.length > 0) {
            pdfList.innerHTML = '';
            
            data.pdfs.forEach(pdf => {
              const pdfItem = document.createElement('div');
              pdfItem.className = 'pdf-item';
              
              const createdDate = new Date(pdf.created * 1000);
              const formattedDate = createdDate.toLocaleString();
              
              pdfItem.innerHTML = `
                <div class="pdf-icon"><i class="fas fa-file-pdf"></i></div>
                <div class="pdf-info">
                  <div class="pdf-name">${pdf.filename}</div>
                  <div class="pdf-date">${formattedDate}</div>
                </div>
                <div class="pdf-actions">
                  <a href="${pdf.url}" target="_blank" class="pdf-view-btn" title="View PDF">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="${pdf.url}" download class="pdf-download-btn" title="Download PDF">
                    <i class="fas fa-download"></i>
                  </a>
                </div>
              `;
              
              pdfList.appendChild(pdfItem);
            });
          } else {
            pdfList.innerHTML = '<div class="pdf-empty"><p>No mock exams generated yet.</p><p>Chat with the AI to create one!</p></div>';
          }
        } catch (error) {
          console.error('Error fetching PDFs:', error);
          pdfList.innerHTML = '<div class="pdf-error"><p>Error loading PDFs. Please try again.</p></div>';
        }
      }

      // Function to show typing indicator
      function showTypingIndicator() {
        if (isAgentTyping) return;
        
        isAgentTyping = true;
        const typingDiv = document.createElement("div");
        typingDiv.id = "typing-indicator";
        typingDiv.className = "message agent typing-indicator";
        typingDiv.innerHTML = `
          <div class="message-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        `;
        messagesDiv.appendChild(typingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Function to hide typing indicator
      function hideTypingIndicator() {
        if (!isAgentTyping) return;
        
        isAgentTyping = false;
        const typingIndicator = document.getElementById("typing-indicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Function to add a message to the chat
      function addMessage(text, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = isUser ? "message user" : "message agent";
        
        // Create avatar
        const avatarDiv = document.createElement("div");
        avatarDiv.className = "message-avatar";
        avatarDiv.innerHTML = isUser ? 
          '<i class="fas fa-user"></i>' : 
          '<i class="fas fa-robot"></i>';
        
        // Create message content
        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        
        if (isUser) {
          contentDiv.textContent = text;
          messageDiv.appendChild(avatarDiv);
          messageDiv.appendChild(contentDiv);
        } else {
          if (!currentMessageId) {
            hideTypingIndicator();
            currentMessageId = "agent-" + Date.now();
            messageDiv.id = currentMessageId;
            
            // Check if text contains PDF file notification
            const pdfRegex = /generated|created|produced|completed|finished|ready|available|exam|mock|pdf/i;
            if (pdfRegex.test(text)) {
              // Schedule PDF refresh if text indicates a PDF might be created
              setTimeout(fetchPDFs, 1000);
              setTimeout(fetchPDFs, 3000); // Try again after 3 seconds in case it takes time to write the file
            }
            
            contentDiv.textContent = text;
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
          } else {
            const existingMessage = document.getElementById(currentMessageId);
            if (existingMessage) {
              const existingContent = existingMessage.querySelector(".message-content");
              existingContent.textContent += text;
            }
          }
        }
        
        if (isUser) {
          messagesDiv.appendChild(messageDiv);
          showTypingIndicator();
        }
        
        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // WebSocket handlers
      function addWebSocketHandlers(ws) {
        ws.onopen = function () {
          console.log("WebSocket connection opened.");
          document.getElementById("sendButton").disabled = false;
          updateConnectionStatus(true);
          
          // Remove welcome message when connection is established
          const welcomeMessage = document.querySelector(".welcome-message");
          if (welcomeMessage) {
            welcomeMessage.classList.add("fade-out");
            setTimeout(() => {
              if (welcomeMessage && welcomeMessage.parentNode) {
                welcomeMessage.parentNode.removeChild(welcomeMessage);
              }
            }, 500);
          }
          
          // Initial PDF fetch
          fetchPDFs();
          
          // Set interval to check for new PDFs every 5 seconds
          pdfCheckInterval = setInterval(fetchPDFs, 5000);
          
          addSubmitHandler(this);
        };

        ws.onmessage = function (event) {
          // Parse the incoming message
          const packet = JSON.parse(event.data);
          console.log(packet);

          // Check if the turn is complete
          if (packet.turn_complete && packet.turn_complete == true) {
            currentMessageId = null;
            
            // Check for PDFs after turn is complete (in case one was generated)
            setTimeout(fetchPDFs, 1000);
            return;
          }

          // Handle message content
          if (packet.message) {
            addMessage(packet.message, false);
          }
        };

        // When the connection is closed, try reconnecting
        ws.onclose = function () {
          console.log("WebSocket connection closed.");
          document.getElementById("sendButton").disabled = true;
          updateConnectionStatus(false);
          
          // Clear PDF check interval
          if (pdfCheckInterval) {
            clearInterval(pdfCheckInterval);
          }
          
          setTimeout(function () {
            console.log("Reconnecting...");
            ws = new WebSocket(ws_url);
            addWebSocketHandlers(ws);
          }, 5000);
        };

        ws.onerror = function (e) {
          console.log("WebSocket error: ", e);
          updateConnectionStatus(false);
        };
      }
      
      addWebSocketHandlers(ws);

      // Add submit handler to the form
      function addSubmitHandler(ws) {
        messageForm.onsubmit = function (e) {
          e.preventDefault();
          const message = messageInput.value.trim();
          if (message) {
            addMessage(message, true);
            ws.send(message);
            messageInput.value = "";
          }
          return false;
        };
      }

      // Add refresh button handler
      refreshPdfsButton.addEventListener("click", function() {
        this.classList.add("refreshing");
        fetchPDFs().then(() => {
          setTimeout(() => {
            this.classList.remove("refreshing");
          }, 500);
        });
      });

      // Enable sending messages with Enter key
      messageInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          document.getElementById("sendButton").click();
        }
      });
    </script>
  </body>
</html>